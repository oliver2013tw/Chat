<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Chat Luxury</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg1:#020617;
  --bg2:#0f172a;
  --card:rgba(255,255,255,.05);
  --border:rgba(255,255,255,.1);
  --accent:#6366f1;
}

*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html,body{
  margin:0; width:100%; height:100%; overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background: radial-gradient(circle at top right, #1e1b4b, #000);
  color:white;
}

/* ===== Login / Loading Screen ===== */
#login{
  position:fixed; inset:0; z-index:999;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background:#020617;
  transition: opacity 0.5s;
}

/* 白色圓弧動畫核心 */
.arc-loader {
  width: 80px; height: 80px;
  position: relative;
  border-radius: 50%;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.3s;
}
.arc-loader:active { transform: scale(0.95); }

.arc-loader::before {
  content: ""; position: absolute; inset: 0;
  border-radius: 50%; padding: 2px;
  background: conic-gradient(from 0deg, transparent 20%, #ffffff);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.login-text { font-weight: 800; letter-spacing: 1px; font-size: 14px; }
.hint { margin-top: 20px; color: #64748b; font-size: 12px; }

/* ===== Chat Interface ===== */
#chat{
  display:none; /* 預設隱藏 */
  height:100%; width:100%; max-width:500px;
  margin:auto; padding:15px;
  flex-direction:column;
}

#messages{
  flex:1; overflow-y:auto;
  display:flex; flex-direction:column; gap:12px;
  padding-bottom:15px; scroll-behavior: smooth;
}

.msg{
  max-width:80%; padding:12px 16px; border-radius:18px;
  background:var(--card); border:1px solid var(--border);
  font-size: 15px; line-height: 1.5;
  backdrop-filter: blur(10px);
  word-wrap: break-word;
}

.mine{ align-self:flex-end; background:var(--accent); border:none; }

#inputBar{
  display:flex; gap:10px; padding-top: 10px;
  border-top: 1px solid var(--border);
}

#inputBar input{
  flex:1; padding:12px 18px; border-radius:25px;
  border:1px solid var(--border); background:rgba(255,255,255,0.05);
  color:white; outline:none; font-size: 16px;
}

#inputBar button{
  width: 45px; height: 45px; border-radius:50%;
  border:none; background:var(--accent);
  color:white; font-weight:700; cursor:pointer;
  display: flex; align-items: center; justify-content: center;
}
</style>
</head>

<body>

<div id="login">
  <div class="arc-loader" id="loginBtn">
    <span class="login-text">LOGIN</span>
  </div>
  <div class="hint" id="statusText">點擊圓圈登入</div>
</div>

<div id="chat">
  <div style="padding-bottom:15px; display:flex; justify-content:space-between; align-items:center">
    <span style="font-weight:800; font-size:1.2rem">Chat</span>
    <button onclick="auth.signOut()" style="background:none; border:none; color:#ff4b5c; font-weight:bold; cursor:pointer">登出</button>
  </div>
  
  <div id="messages"></div>
  
  <div id="inputBar">
    <input id="msgInput" placeholder="輸入訊息...">
    <button id="sendBtn">➤</button>
  </div>
</div>

<script>
// 1. 初始化 Firebase (使用正確的設定)
const firebaseConfig = {
  apiKey: "AIzaSyA6VaL_I9s6Wm3RFjNP5iHxFLp4hgQhkpc",
  authDomain: "kreon-chat-web.firebaseapp.com",
  databaseURL: "https://kreon-chat-web-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kreon-chat-web",
  storageBucket: "kreon-chat-web.firebasestorage.app",
  messagingSenderId: "497509136448",
  appId: "1:497509136448:web:4899641de83c4f872d47a5"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

// 2. 取得 DOM 元素 (避免變數未定義錯誤)
const loginDiv = document.getElementById("login");
const chatDiv = document.getElementById("chat");
const loginBtn = document.getElementById("loginBtn");
const statusText = document.getElementById("statusText");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const msgBox = document.getElementById("messages");

// 3. 登入按鈕點擊事件
loginBtn.onclick = () => {
  statusText.innerText = "正在連接 Google...";
  const provider = new firebase.auth.GoogleAuthProvider();
  // 強制使用 Redirect 確保手機相容性
  auth.signInWithRedirect(provider);
};

// 4. 處理 Redirect 回來後的狀態 (關鍵修復)
auth.getRedirectResult().catch(err => {
  console.error("Login Error:", err);
  statusText.innerText = "登入失敗，請重試";
});

// 5. 核心：監聽登入狀態並切換畫面
auth.onAuthStateChanged(user => {
  if (user) {
    console.log("已登入:", user.email);
    // 強制隱藏登入頁，顯示聊天頁
    loginDiv.style.display = "none";
    chatDiv.style.display = "flex";
    initChat(user);
  } else {
    console.log("未登入");
    loginDiv.style.display = "flex";
    chatDiv.style.display = "none";
    statusText.innerText = "點擊圓圈登入";
  }
});

// 6. 聊天室邏輯
function initChat(user) {
  const ref = db.ref("messages");
  
  // 移除舊的監聽器，避免重複
  ref.limitToLast(50).off();
  
  msgBox.innerHTML = ""; // 清空畫面

  // 接收訊息
  ref.limitToLast(50).on("child_added", snapshot => {
    const data = snapshot.val();
    const div = document.createElement("div");
    // 判斷是誰發的
    const isMe = data.uid === user.uid;
    div.className = "msg " + (isMe ? "mine" : "");
    div.innerText = data.text;
    
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight; // 自動捲動到底部
  });

  // 發送訊息函數
  const sendMessage = () => {
    const text = msgInput.value.trim();
    if (!text) return;
    
    ref.push({
      uid: user.uid,
      name: user.displayName || "User",
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    msgInput.value = "";
  };

  // 綁定發送按鈕與 Enter 鍵
  sendBtn.onclick = sendMessage;
  msgInput.onkeydown = (e) => {
    if (e.key === "Enter") sendMessage();
  };
}
</script>
</body>
</html>
