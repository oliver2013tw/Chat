<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#020617;
  --card:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.15);
  --accent:#6366f1;
}

*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body, html{
  margin:0; width:100%; height:100%; overflow:hidden;
  font-family:-apple-system, system-ui, sans-serif;
  background: var(--bg); color:white;
}

/* ===== Login ===== */
#login{
  position:fixed; inset:0; z-index:9999;
  display:flex; align-items:center; justify-content:center;
  background: var(--bg);
}

.login-card{
  width:320px; padding:40px; border-radius:28px;
  background:var(--card); backdrop-filter:blur(20px);
  border:1px solid var(--border); text-align:center;
}

#loginBtn{
  width:100%; padding:16px; border-radius:16px; border:none;
  font-size:16px; font-weight:700; background:white; color:black;
  cursor:pointer;
}

/* ===== Chat ===== */
#chat{
  display:none; /* åˆå§‹éš±è—ï¼Œç”± JS å¼·åˆ¶é–‹å•Ÿ */
  height:100dvh; width:100%; max-width:450px;
  margin:auto; padding:15px; flex-direction:column;
}

#messages{
  flex:1; overflow-y:auto; display:flex; flex-direction:column;
  gap:12px; padding:10px 0;
}

.msg{
  max-width:80%; padding:12px 16px; border-radius:18px;
  background:var(--card); border:1px solid var(--border);
  font-size:15px; word-wrap:break-word;
}

.mine{ align-self:flex-end; background:var(--accent); border:none; }

#inputBar{ display:flex; gap:10px; padding:10px 0 env(safe-area-inset-bottom); }

#inputBar input{
  flex:1; padding:14px; border-radius:14px; border:none;
  background:var(--card); color:white; outline:none;
}

#inputBar button{
  padding:0 20px; border-radius:14px; border:none;
  background:var(--accent); color:white; font-weight:700;
}
</style>
</head>
<body>

<div id="login">
  <div class="login-card">
    <h1 style="margin-top:0">Chat</h1>
    <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>
</div>

<div id="chat">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
    <b style="font-size:20px">Chat</b>
    <span onclick="auth.signOut()" style="opacity:0.5; font-size:14px">ç™»å‡º</span>
  </div>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯...">
    <button id="sendBtn">é€å‡º</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA6VaL_I9s6Wm3RFjNP5iHxFLp4hgQhkpc",
  authDomain: "kreon-chat-web.firebaseapp.com",
  databaseURL: "https://kreon-chat-web-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kreon-chat-web"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const loginLayer = document.getElementById("login");
const chatLayer = document.getElementById("chat");

// âš¡ æ ¸å¿ƒï¼šå¼·è¡Œåˆ‡æ›å‡½æ•¸
function forceShowChat(user) {
  if (!user) return;
  // ç›´æ¥ç§»é™¤ç™»å…¥å±¤ï¼Œç¢ºä¿å®ƒä¸æœƒå› ç‚ºä»»ä½•åŸå› æ“‹åœ¨å‰é¢
  if (loginLayer && loginLayer.parentNode) {
    loginLayer.parentNode.removeChild(loginLayer);
  }
  chatLayer.style.display = "flex";
  initChat(user);
}

// ç›£è½ç‹€æ…‹
auth.onAuthStateChanged(user => {
  if (user) {
    forceShowChat(user);
  } else {
    // å¦‚æœç™»å‡ºæˆ–æœªç™»å…¥ï¼Œé‡æ–°æ•´ç†é é¢å›åˆ°åˆå§‹ç‹€æ…‹
    if (!loginLayer.parentNode) location.reload();
  }
});

// è™•ç† Redirect å®Œçš„çµæœ
auth.getRedirectResult().then(res => {
  if (res && res.user) forceShowChat(res.user);
});

// ç™»å…¥æŒ‰éˆ•
document.getElementById("loginBtn").onclick = () => {
  const p = new firebase.auth.GoogleAuthProvider();
  auth.signInWithRedirect(p);
};

function initChat(user) {
  const box = document.getElementById("messages");
  const ref = db.ref("messages");
  
  ref.off(); // æ¸…é™¤èˆŠç›£è½
  box.innerHTML = "";

  ref.limitToLast(50).on("child_added", snap => {
    const m = snap.val();
    const d = document.createElement("div");
    d.className = "msg " + (m.uid === user.uid ? "mine" : "");
    d.innerText = m.text;
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
  });

  const send = () => {
    const inp = document.getElementById("msgInput");
    if (!inp.value.trim()) return;
    ref.push({ uid: user.uid, text: inp.value });
    inp.value = "";
  };

  document.getElementById("sendBtn").onclick = send;
  document.getElementById("msgInput").onkeydown = (e) => { if(e.key === "Enter") send(); };
}

// ğŸ›¡ï¸ Chrome è¡Œå‹•ç‰ˆä¿éšªï¼šè‹¥åµæ¸¬åˆ° User ä½†ç•«é¢æ²’å‹•ï¼Œ0.5 ç§’å¾ŒåŸ·è¡Œå¼·åˆ¶åˆ‡æ›
setTimeout(() => {
  if (auth.currentUser) forceShowChat(auth.currentUser);
}, 500);
</script>
</body>
</html>
