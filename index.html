<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Chat Glass</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg-dark: #020617;
  --glass: rgba(255, 255, 255, 0.05);
  --border: rgba(255, 255, 255, 0.1);
  --primary: #6366f1;
  --danger: #ff4b5c;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body, html {
  margin: 0; width: 100%; height: 100%; overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top right, #1e1b4b, #020617);
  color: white;
}

/* ===== 登入介面 (長方形按鈕版) ===== */
#login {
  position: fixed; inset: 0; z-index: 999;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-dark);
  transition: opacity 0.3s;
}

.login-card {
  width: 85%; max-width: 320px;
  padding: 40px 30px;
  border-radius: 24px;
  background: var(--glass);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border);
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

.login-card h1 {
  margin: 0 0 30px; font-size: 28px; font-weight: 800; letter-spacing: 1px;
}

/* 圓角長方形按鈕 */
.login-btn {
  width: 100%; padding: 16px;
  border-radius: 16px; border: none;
  background: white; color: #020617;
  font-size: 16px; font-weight: 700;
  cursor: pointer; transition: transform 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.login-btn:active { transform: scale(0.96); opacity: 0.9; }

/* ===== 聊天介面 ===== */
#chat {
  display: none; /* 預設隱藏 */
  flex-direction: column;
  height: 100%; max-width: 600px; margin: auto;
}

header {
  height: 60px; padding: 0 20px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(2, 6, 23, 0.8); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
}

#messages {
  flex: 1; overflow-y: auto; padding: 20px;
  display: flex; flex-direction: column; gap: 12px;
  scroll-behavior: smooth;
}

.msg {
  max-width: 80%; padding: 12px 16px;
  border-radius: 18px; font-size: 15px; line-height: 1.5;
  background: var(--glass); border: 1px solid var(--border);
  backdrop-filter: blur(10px); word-break: break-all;
}
.mine { align-self: flex-end; background: var(--primary); border: none; }
.other { align-self: flex-start; }

footer {
  height: 80px; padding: 0 15px; flex-shrink: 0;
  display: flex; align-items: center; gap: 10px;
  background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
}

input {
  flex: 1; height: 46px; padding: 0 20px;
  border-radius: 23px; border: 1px solid var(--border);
  background: rgba(255,255,255,0.05); color: white;
  font-size: 16px; outline: none;
}

.send-btn {
  width: 46px; height: 46px; border-radius: 50%;
  border: none; background: var(--primary); color: white;
  font-size: 20px; font-weight: bold; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

/* 彈出選單 */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.8);
  display: none; align-items: center; justify-content: center; z-index: 2000;
  backdrop-filter: blur(5px);
}
.menu-box {
  width: 260px; background: #1e293b; border-radius: 20px;
  border: 1px solid var(--border); overflow: hidden;
}
.menu-btn {
  padding: 16px; text-align: center; border-bottom: 1px solid var(--border);
  cursor: pointer; font-weight: 500;
}
.menu-btn:active { background: rgba(255,255,255,0.05); }

/* 管理員面板 */
#adminPanel {
  position: fixed; inset: 0; background: #020617; z-index: 3000;
  display: none; flex-direction: column;
}
</style>
</head>

<body>

<div id="login">
  <div class="login-card">
    <h1>Chat</h1>
    <button id="loginBtn" class="login-btn">
      使用 Google 登入
    </button>
  </div>
</div>

<div id="chat">
  <header>
    <div style="display:flex; align-items:center; gap:10px">
      <span style="font-weight:800; font-size:1.2rem">Chat</span>
      <span id="online" style="font-size:11px; opacity:0.6">...</span>
    </div>
    <div style="display:flex; gap:15px; align-items:center">
      <span id="admGear" style="display:none; color:#fbbf24; cursor:pointer; font-size:20px" onclick="toggleAdmin(true)">⚙</span>
      <span onclick="auth.signOut()" style="color:#ff4b5c; cursor:pointer; font-weight:bold; font-size:14px">登出</span>
    </div>
  </header>

  <div id="messages"></div>

  <footer>
    <input id="msgInput" placeholder="輸入訊息...">
    <button id="sendBtn" class="send-btn">➤</button>
  </footer>
</div>

<div id="msgMenu" class="overlay" onclick="this.style.display='none'">
  <div class="menu-box">
    <div class="menu-btn" onclick="copy()">複製內容</div>
    <div id="admDel" class="menu-btn" style="display:none; color:#ff4b5c; font-weight:bold" onclick="del()">刪除訊息</div>
    <div class="menu-btn" style="opacity:0.6">取消</div>
  </div>
</div>

<div id="adminPanel">
  <header style="background:#0f172a">
    <span>管理中心</span>
    <span style="cursor:pointer; font-size:20px" onclick="toggleAdmin(false)">✕</span>
  </header>
  <div id="userList" style="flex:1; overflow-y:auto"></div>
</div>

<script>
// 1. Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA6VaL_I9s6Wm3RFjNP5iHxFLp4hgQhkpc",
  authDomain: "kreon-chat-web.firebaseapp.com",
  databaseURL: "https://kreon-chat-web-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kreon-chat-web",
  storageBucket: "kreon-chat-web.firebasestorage.app",
  messagingSenderId: "497509136448",
  appId: "1:497509136448:web:4899641de83c4f872d47a5"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const ADMIN = "oliver2013.tw@gmail.com";

let curMid="", curUid="", curTxt="";

// 2. 登入邏輯 (修復手機跳轉)
document.getElementById("loginBtn").onclick = function() {
  this.innerText = "處理中...";
  const p = new firebase.auth.GoogleAuthProvider();
  // 強制使用 Redirect，這在手機上最穩定
  auth.signInWithRedirect(p);
};

// 處理 Redirect 回來的狀態
auth.getRedirectResult().catch(e => {
  console.error(e);
  document.getElementById("loginBtn").innerText = "使用 Google 登入";
  alert("登入失敗");
});

// 3. 狀態監聽 (強制切換介面)
auth.onAuthStateChanged(async user => {
  const loginDiv = document.getElementById("login");
  const chatDiv = document.getElementById("chat");

  if(user) {
    // 檢查封鎖
    const ban = await db.ref("banned/"+user.uid).get();
    if(ban.exists()) { alert("已被封鎖"); auth.signOut(); return; }

    // 強制切換
    loginDiv.style.display = "none";
    chatDiv.style.display = "flex";

    // 管理員檢查
    if(user.email === ADMIN) {
      document.getElementById("admGear").style.display = "block";
      document.getElementById("admDel").style.display = "block";
    }

    initChat(user);
  } else {
    loginDiv.style.display = "flex";
    chatDiv.style.display = "none";
    document.getElementById("loginBtn").innerText = "使用 Google 登入";
  }
});

// 4. 聊天功能
function initChat(user) {
  // 在線人數
  const onlineRef = db.ref("online/"+user.uid);
  onlineRef.set(true); onlineRef.onDisconnect().remove();
  db.ref("online").on("value", s => document.getElementById("online").innerText = s.numChildren()+" 在線");

  // 訊息載入
  const box = document.getElementById("messages");
  const ref = db.ref("messages");
  box.innerHTML = "";
  
  ref.limitToLast(50).off();
  ref.limitToLast(50).on("child_added", s => {
    const m = s.val();
    const isMe = m.uid === user.uid;
    const div = document.createElement("div");
    div.className = "msg " + (isMe ? "mine" : "other");
    div.innerText = m.text;
    
    // 長按選單邏輯
    let t;
    const showMenu = () => {
      curMid=s.key; curUid=m.uid; curTxt=m.text;
      document.getElementById("msgMenu").style.display = "flex";
    };
    div.ontouchstart = () => t = setTimeout(showMenu, 600);
    div.ontouchend = () => clearTimeout(t);
    div.oncontextmenu = e => { e.preventDefault(); showMenu(); };

    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  });

  // 發送
  const send = () => {
    const inp = document.getElementById("msgInput");
    const txt = inp.value.trim();
    if(!txt) return;
    ref.push({ uid: user.uid, name: user.displayName, text: txt });
    inp.value = "";
  };

  document.getElementById("sendBtn").onclick = send;
  document.getElementById("msgInput").onkeydown = e => { if(e.key==="Enter") send(); };
}

// 5. 其他功能
function copy() { navigator.clipboard.writeText(curTxt); alert("已複製"); }
function del() { if(confirm("確定刪除？")) db.ref("messages/"+curMid).remove(); }

async function toggleAdmin(show) {
  const p = document.getElementById("adminPanel");
  p.style.display = show ? "flex" : "none";
  if(show) {
    const l = document.getElementById("userList");
    l.innerHTML = "<p style='padding:20px'>載入中...</p>";
    const s = await db.ref("messages").limitToLast(100).get();
    const u = {};
    Object.values(s.val()||{}).forEach(m => u[m.uid]=m.name);
    l.innerHTML="";
    Object.keys(u).forEach(uid => {
      const d = document.createElement("div");
      d.style = "display:flex; justify-content:space-between; padding:20px; border-bottom:1px solid #333";
      d.innerHTML = `<span>${u[uid]}</span><button onclick="ban('${uid}')" style="background:#ff4b5c; color:white; border:none; padding:6px 12px; border-radius:8px">封鎖</button>`;
      l.appendChild(d);
    });
  }
}

function ban(uid) {
  if(confirm("確定封鎖？")) { db.ref("banned/"+uid).set(true); toggleAdmin(true); }
}
</script>
</body>
</html>
