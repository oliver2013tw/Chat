<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg1:#020617; --bg2:#020024;
  --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.15);
  --accent:#6366f1;
}

*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html,body{
  margin:0; width:100%; height:100%; overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background: linear-gradient(135deg, var(--bg1), var(--bg2));
  color:white;
}

/* Login Page */
#login{
  position:fixed; inset:0; z-index:10;
  display:flex; align-items:center; justify-content:center;
  background: inherit;
}

.login-card{
  width:320px; padding:40px; border-radius:28px;
  background:var(--card); backdrop-filter:blur(20px);
  border:1px solid var(--border); text-align:center;
}

#loginBtn{
  width:100%; padding:15px; border-radius:16px; border:none;
  font-size:16px; font-weight:700; background:white; color:black;
  cursor:pointer;
}

/* Chat Page */
#chat{
  display:none; /* 初始隱藏，必須由 JS 改為 flex */
  height:100%; width:100%; max-width:430px;
  margin:auto; padding:15px; flex-direction:column;
}

#messages{
  flex:1; overflow-y:auto; display:flex; flex-direction:column;
  gap:10px; padding-bottom:10px;
}

.msg{
  max-width:75%; padding:12px 16px; border-radius:18px;
  background:var(--card); border:1px solid var(--border);
  word-wrap: break-word;
}

.mine{ align-self:flex-end; background:var(--accent); border:none; }

#inputBar{ display:flex; gap:10px; padding-bottom: env(safe-area-inset-bottom); }

#inputBar input{
  flex:1; padding:14px; border-radius:16px; border:none;
  outline:none; background:var(--card); color:white;
}

#inputBar button{
  padding:0 20px; border-radius:16px; border:none;
  background:var(--accent); color:white; font-weight:700;
}
</style>
</head>
<body>

<div id="login">
  <div class="login-card">
    <h1 style="margin:0 0 30px">Chat</h1>
    <button id="loginBtn">使用 Google 登入</button>
  </div>
</div>

<div id="chat">
  <div style="display:flex; justify-content:space-between; margin-bottom:10px">
    <b>Chat</b>
    <span onclick="auth.signOut()" style="opacity:0.5; font-size:12px">登出</span>
  </div>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msgInput" placeholder="輸入訊息">
    <button id="sendBtn">送出</button>
  </div>
</div>

<script>
// Firebase 初始化
const firebaseConfig = {
  apiKey: "AIzaSyA6VaL_I9s6Wm3RFjNP5iHxFLp4hgQhkpc",
  authDomain: "kreon-chat-web.firebaseapp.com",
  databaseURL: "https://kreon-chat-web-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kreon-chat-web"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const loginDiv = document.getElementById("login");
const chatDiv = document.getElementById("chat");

// 登入按鈕：Chrome 手機版建議直接用 Redirect
document.getElementById("loginBtn").onclick = () => {
  auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
};

// 狀態監聽與 UI 切換
auth.onAuthStateChanged(user => {
  if (user) {
    loginDiv.style.display = "none";
    chatDiv.style.display = "flex";
    startChat(user);
  } else {
    loginDiv.style.display = "flex";
    chatDiv.style.display = "none";
  }
});

function startChat(user) {
  const msgBox = document.getElementById("messages");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const ref = db.ref("messages");

  ref.off();
  msgBox.innerHTML = "";

  ref.limitToLast(50).on("child_added", snap => {
    const data = snap.val();
    const div = document.createElement("div");
    div.className = "msg " + (data.uid === user.uid ? "mine" : "");
    div.innerText = data.text;
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight;
  });

  const handleSend = () => {
    const text = msgInput.value.trim();
    if (!text) return;
    ref.push({ uid: user.uid, text: text });
    msgInput.value = "";
  };

  sendBtn.onclick = handleSend;
  msgInput.onkeydown = (e) => { if (e.key === "Enter") handleSend(); };
}
</script>
</body>
</html>
